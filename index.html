<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T&T Serenity Care | Secure Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .main-bg {
            background: linear-gradient(135deg, #4854a8 0%, #583e85 100%);
        }
        .input-field:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
            outline: none;
        }
        .error-shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        .card-enter {
            animation: card-enter 0.6s ease-out forwards;
            opacity: 0;
        }
        @keyframes card-enter {
            from {
                opacity: 0;
                transform: translateY(25px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .logo-font {
            font-family: 'Playfair Display', serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        #email-draft-text {
            resize: none;
        }

        .hero-name {
            color: #f0f0f0;
            text-shadow: 0 0 15px rgba(230, 230, 255, 0.7), 0 0 5px rgba(230, 230, 255, 0.7);
        }

        .heading-color {
            color: #C2B2FF; /* Electric Lavender */
        }
        .label-color {
            color: #d1c4e9; /* Soft Lavender */
        }
        .body-text-color {
            color: #E8E2F9; /* Off-white */
        }

        .alert-heading-color {
            color: #FFC0CB; /* Lighter red for heading */
            text-shadow: 0 0 8px rgba(255, 100, 100, 0.6);
        }
        .alert-label-color {
             color: #F5B9BD;
        }
        
        .card-hover-effect {
            transition: all 0.3s ease-in-out;
        }

        .card-hover-effect:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px 0 rgba(20, 24, 80, 0.4);
            background: rgba(255, 255, 255, 0.20);
        }


    </style>
</head>
<body class="main-bg min-h-screen flex items-center justify-center p-4">

    <!-- Login Section -->
    <div id="login-section" class="w-full max-w-md">
        <div class="glass-container p-8 text-white text-center">
            <div class="mx-auto mb-4">
                <h1 class="text-6xl logo-font">T&T</h1>
                <p class="text-xl opacity-90 tracking-wider">Serenity Care</p>
            </div>
            <p class="text-lg opacity-80 mb-8">Secure Referral Portal</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="Enter Username" class="input-field w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/70 focus:ring-2 focus:ring-white/50 transition duration-300">
                <input type="password" id="access-code" placeholder="Enter Access Code" class="input-field w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/70 focus:ring-2 focus:ring-white/50 transition duration-300">
                <button id="submit-button" class="w-full bg-white text-[#764ba2] font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition duration-300 transform hover:scale-105">
                    Access Information
                </button>
            </div>
            <p id="error-message" class="text-red-300 mt-4 h-4"></p>
        </div>
    </div>

    <!-- Referral List Section -->
    <div id="referral-list-section" class="hidden w-full max-w-5xl"> 
        <div class="glass-container p-6 md:p-10">
            <header class="flex justify-between items-center mb-8 border-b border-white/30 pb-4">
                 <div class="text-white">
                    <h1 class="text-3xl logo-font">T&T</h1>
                    <p class="text-md opacity-90 tracking-wider">Serenity Care</p>
                </div>
                <button id="logout-button-list" class="bg-red-500/50 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-500/80 transition duration-300">
                    Log Out
                </button>
            </header>
             <h1 class="text-2xl md:text-3xl font-bold text-white mb-6 text-center">Active Referrals</h1>
            <div id="referrals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"> 
                <!-- Referral cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Referral Detail Section -->
    <div id="referral-detail-section" class="hidden w-full max-w-7xl">
        <div class="glass-container p-6 md:p-8 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-white/30 pb-4">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <button id="back-to-list-button" class="bg-white/20 text-white font-semibold py-2 px-5 rounded-lg hover:bg-white/40 transition duration-300">
                        &larr; Back
                    </button>
                </div>
                <button id="logout-button-detail" class="bg-red-500/50 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-500/80 transition duration-300">
                    Log Out
                </button>
            </header>

            <main id="detail-content" class="text-white">
                <!-- Detailed referral info will be dynamically inserted here -->
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            // Added referralSentDate (YYYY-MM-DD format for easy sorting)
            const referralsData = [
                {
                    id: 66281,
                    name: "Phoenix W****",
                    fullName: "Phoenix W****",
                    emailFullName: "Phoenix Williams",
                    referralSentDate: "2025-10-20", // Extracted from Referral Email.png timestamp
                    dob: "July 19, 2007 (Age 18)",
                    legalRep: "Katrina W**** (Adoptive Mother)",
                    legalRepPhone: "(407) 791-5230",
                    legalRepEmail: "kwilliams33012@cfl.rr.com",
                    wscName: "Karen Massay-Brank",
                    wscPhone: "(407) 908-9018",
                    wscEmail: "kmassayb1@outlook.com",
                    referralContactName: "Lisa T****",
                    referralContactEmail: "lisa.thompson@apdcares.org",
                    residence: "Family Home, Ocoee, FL",
                    referralType: "Respite Placement",
                    dates: "Nov 6, 2025 - Nov 9, 2025",
                    primaryDiagnosis: "Spina Bifida",
                    otherDiagnoses: "Autism, ADHD, Fetal Alcohol Syndrome, Anxiety, PTSD, Asthma, Glaucoma.",
                    accommodations: "Manages neurogenic bowel via ACE procedure and uses a catheter (total assistance needed).",
                    medications: "Requires full management. Takes Seroquel, Concerta, Ritalin, Omeprazole under a medication trial.",
                    allergies: "Severe allergy to tree nuts, peanuts, and seafood.",
                    qsiPhysical: 6,
                    qsiFunctional: 4,
                    qsiBehavioral: 3,
                    functionalGeneral: "Requires assistance in all major adaptive skills.",
                    functionalVision: "Impaired (glaucoma, color blindness). Needs help matching clothes.",
                    functionalHygiene: "Requires step-by-step verbal prompts and supervision. History of pretending to shower.",
                    functionalCommunication: "Difficulty with verbal expression; does not initiate with strangers.",
                    evacuationRisk: "HIGH. Will not wake to alarms due to medication. Requires direct physical assistance to evacuate.",
                    behavioralIssues: "Elopement history, non-compliance, telling lies (especially about care), and poor impulse control.",
                    behavioralSocial: "Vulnerable with strangers despite being friendly.",
                    behavioralHistory: "Notes of Self-Injurious Behavior (SIB) and disruptive behaviors.",
                    socialBackground: "Adopted. History of significant trauma (sexual abuse) prior to entering foster care.",
                    socialDailyLife: "Attends High School (12th grade) and works part-time via a VR program. Thrives on routine.",
                    socialGoals: "Aspires to live independently, learn financial skills, and become more disciplined.",
                    assets: {
                        email: "assets/66281_Referral_Email.png",
                        form: "assets/66281_Residential%20Referral%20Form.pdf",
                        pcsp: "assets/66281_WILLIAMS_PHOENIX%20PCSP%2008_2025.pdf",
                        qsi: "assets/66281_WILLIAMS_PHOENIX%20QSI%20Complete%2006_03_2025.pdf"
                    }
                },
                {
                    id: 76234,
                    name: "Hunter W****",
                    fullName: "Hunter W****",
                    emailFullName: "Hunter Williams",
                    referralSentDate: "2025-10-20", // Extracted from 76234_Referral Email.png timestamp
                    dob: "March 29, 2005 (Age 20)",
                    legalRep: "Katrina W**** (Adoptive Mother)",
                    legalRepPhone: "(407) 791-5230",
                    legalRepEmail: "kwilliams33012@cfl.rr.com",
                    wscName: "Karen Massay-Brank",
                    wscPhone: "(407) 908-9018",
                    wscEmail: "kmassayb1@outlook.com",
                    referralContactName: "Lisa T****",
                    referralContactEmail: "lisa.thompson@apdcares.org",
                    residence: "Family Home, Ocoee, FL",
                    referralType: "Respite Placement",
                    dates: "Nov 6, 2025 - Nov 9, 2025",
                    primaryDiagnosis: "Intellectual Disability",
                    otherDiagnoses: "Autism, Depression, ADHD.",
                    accommodations: "No major physical accommodations noted, but requires assistance with most ADLs.",
                    medications: "Requires full management. Takes Focalin, Remeron, Lexapro, Intuniv, Symbicort, Vyvanse.",
                    allergies: "Environmental allergies. No known food allergies.",
                    qsiPhysical: 2,
                    qsiFunctional: 3,
                    qsiBehavioral: 2,
                    functionalGeneral: "Requires assistance in most adaptive skills, independent in toileting.",
                    functionalVision: "Color blind, requires assistance matching clothes.",
                    functionalHygiene: "Requires verbal prompts and supervision, similar history of pretending to shower.",
                    functionalCommunication: "Does not initiate communication and will not self-report illness or injury. This has led to a past hospitalization.",
                    evacuationRisk: "MODERATE. Will wake to alarms but would wait for direction rather than evacuating independently.",
                    behavioralIssues: "History of elopement, non-compliance, telling lies, and poor socialization skills. History of unauthorized breaks at work placements.",
                    behavioralSocial: "Can be defiant and has anger issues. Easily influenced by others.",
                    behavioralHistory: "History of inappropriate sexual behavior with sibling at a young age. Requires monitoring.",
                    socialBackground: "Adopted. Former foster child.",
                    socialDailyLife: "Attends college classes with support and uses Access Lynx for transport. Has had multiple on-the-job training placements.",
                    socialGoals: "Wants to live in a group home, eventually an apartment, and complete a college certification.",
                     assets: {
                        email: "assets/76234_Referral%20Email.png",
                        form: "assets/76234_Residential%20Referral%20Form.pdf",
                        pcsp: "assets/76234_WILLIAMS_HUNTER%20PCSP%2009_2025.pdf",
                        qsi: "assets/76234_WILLIAMS_HUNTER%20QSI%20Complete%2006_03_2025.pdf"
                    }
                },
                { 
                    id: 12527,
                    name: "April R****",
                    fullName: "April R****",
                    emailFullName: "April Ratner",
                    referralSentDate: "2025-10-23", // Extracted from 12527 - Residential Referral Email.png timestamp
                    dob: "August 3, 1967 (Age 58)",
                    legalRep: "Sonia H**** (Mother)",
                    legalRepPhone: "(386) 453-1333",
                    legalRepEmail: "N/A", 
                    wscName: "Rocio Rosario",
                    wscPhone: "(386) 473-5784",
                    wscEmail: "RRosario@ovginc.net",
                    referralContactName: "Kerry C****", 
                    referralContactEmail: "Kerry.Clark@apdcares.org", 
                    residence: "Family Home, Ormond Beach, FL",
                    referralType: "Respite Placement",
                    dates: "Nov 14, 2025 - Nov 17, 2025",
                    primaryDiagnosis: "Intellectual Disability",
                    otherDiagnoses: "Breast Cancer (Stage 2, Metastatic), High Blood Pressure, High Cholesterol, Arthritis, OCD, Hydrocephalus history, Stroke history.",
                    accommodations: "Uses wheelchair (requires assistance), requires total assistance for transfers, feeding (mostly), toileting (incontinent), hygiene, dressing.",
                    medications: "Requires full management. Takes Pravastatin, Enalapril, Escitalopram, Diphenoxylate, Anastrozole (Chemo), Levetiracetam, Dexamethasone.",
                    allergies: "No Known Allergies (NKA).",
                    qsiPhysical: 3,
                    qsiFunctional: 5,
                    qsiBehavioral: 5, 
                    functionalGeneral: "Dependent in all ADLs.",
                    functionalVision: "No Impairment noted.",
                    functionalHygiene: "Requires total physical assistance.",
                    functionalCommunication: "Non-verbal, communicates via gestures and facial expressions. Capacity decreased since stroke.",
                    evacuationRisk: "DEPENDENT. Requires total physical assistance. Lives on 5th floor, needs plan for stair evacuation.",
                    behavioralIssues: "OCD (skin picking/scratching). Requires constant supervision to prevent self-injury.",
                    behavioralSocial: "Enjoys interaction but cannot protect self. Requires constant supervision.",
                    behavioralHistory: "Self-injurious behavior (skin picking). Requires protective clothing (long sleeves).",
                    socialBackground: "History of hydrocephalus, stroke during double mastectomy (2017/age 50). Ongoing battle with metastatic breast cancer, including recent brain surgery (Aug 2025).",
                    socialDailyLife: "Lives with mother and sister (who is CDC+ provider). Routine varies due to medical appointments/chemotherapy. Enjoys music, car rides, shopping.",
                    socialGoals: "Maintain health, remain safe, continue community outings.",
                     assets: {
                        email: "assets/12527%20-%20Residential%20Referral%20Email.png",
                        form: "assets/12527_Referral.pdf",
                        pcsp: "assets/12527_April%20Ratner%20Personal%20Care%20Support.pdf",
                        qsi: "" // QSI document was not provided for this referral
                    }
                },
                { 
                    id: 82513,
                    name: "J.D. W****",
                    fullName: "J.D. W****",
                    emailFullName: "J.D. Wheeler",
                    referralSentDate: "2025-10-28", // Extracted from 82513 - Residential Referral Email.png timestamp
                    dob: "July 18, 1983 (Age 42)",
                    legalRep: "Su W**** (Parent)", 
                    legalRepPhone: "(618) 401-1339", 
                    legalRepEmail: "wheelersu@gmail.com", 
                    wscName: "Kenneth Keaton", 
                    wscPhone: "(321) 317-5498", 
                    wscEmail: "brentkeaton@gmail.com", 
                    referralContactName: "Lisa T****", 
                    referralContactEmail: "lisa.thompson@apdcares.org", 
                    residence: "Family Home, Titusville, FL",
                    referralType: "Change of Placement (Standard GH)",
                    dates: "N/A (Permanent)",
                    primaryDiagnosis: "Cerebral Palsy",
                    otherDiagnoses: "Gastroparesis, Constipation.",
                    accommodations: "Dependent on wheelchair (manual requires propulsion, power chair needs setup). Fully dependent on transfers. Requires food cut, assistance scooping. Uses briefs but usually continent with prompting (rings bell).",
                    medications: "Requires full management. Takes Linzess, Metoclopramide (prn), Tums, Dulcolax, Senna, Colace.",
                    allergies: "No Known Allergies (NKA).",
                    qsiPhysical: 3, 
                    qsiFunctional: 5, 
                    qsiBehavioral: 1, 
                    functionalGeneral: "Dependent for hygiene, dressing, transfers, ambulation assist. Requires assistance eating, toileting.",
                    functionalVision: "Impaired - Wears glasses.",
                    functionalHygiene: "Total assistance required.",
                    functionalCommunication: "Verbal, but speaks slowly. May need time or clarification questions. Can write.",
                    evacuationRisk: "DEPENDENT. Requires full assistance.",
                    behavioralIssues: "None noted in recent docs. QSI Behavioral score is 1.",
                    behavioralSocial: "Enjoys social interaction. Looks to parents for advice.",
                    behavioralHistory: "No significant history noted.",
                    socialBackground: "Lived in group homes previously (IL 2014-2020, brief Orlando stay). Moved to FL in 2020. Attended college for 2 years.",
                    socialDailyLife: "Temporarily living with aging parents (father has health issues limiting ability to assist). Enjoys iPad (weather, space launches), fishing, sports, Disney, going out daily.",
                    socialGoals: "Move into a new group home, attend ADT, increase social circle.",
                     assets: {
                        email: "assets/82513%20-%20Residential%20Referral%20Email.png",
                        form: "assets/82513_Residential%20Referral%20Form.pdf",
                        pcsp: "assets/82513_PCSP%202025.pdf",
                        qsi: "" // QSI Document not provided
                    }
                }
            ];

            // --- DOM ELEMENTS ---
            const loginSection = document.getElementById('login-section');
            const referralListSection = document.getElementById('referral-list-section');
            const referralDetailSection = document.getElementById('referral-detail-section');
            const usernameInput = document.getElementById('username');
            const accessCodeInput = document.getElementById('access-code');
            const submitButton = document.getElementById('submit-button');
            const errorMessage = document.getElementById('error-message');
            const referralsContainer = document.getElementById('referrals-container');
            const detailContent = document.getElementById('detail-content');
            const backToListButton = document.getElementById('back-to-list-button');
            const logoutButtons = [document.getElementById('logout-button-list'), document.getElementById('logout-button-detail')];
            let qsiChart = null;

            // --- AUTH & ROUTING ---
            const CORRECT_USERNAME = 'tandt';
            const CORRECT_ACCESS_CODE = 'APD2025';

            function showScreen(screen) {
                loginSection.classList.add('hidden');
                referralListSection.classList.add('hidden');
                referralDetailSection.classList.add('hidden');
                screen.classList.remove('hidden');
            }
            
            function logout() {
                sessionStorage.removeItem('isAuthenticated');
                usernameInput.value = '';
                accessCodeInput.value = '';
                showScreen(loginSection);
            }
            
            function handleLogin() {
                const enteredUsername = usernameInput.value.trim().toLowerCase();
                const enteredAccessCode = accessCodeInput.value;
                if (enteredUsername === CORRECT_USERNAME && enteredAccessCode === CORRECT_ACCESS_CODE) {
                    sessionStorage.setItem('isAuthenticated', 'true');
                    displayReferralList();
                    errorMessage.textContent = '';
                } else {
                    errorMessage.textContent = 'Incorrect username or access code.';
                    loginSection.classList.add('error-shake');
                    setTimeout(() => loginSection.classList.remove('error-shake'), 500);
                }
            }

            // --- UTILITY FUNCTIONS ---
            function calculateDaysElapsed(dateString) {
                const referralDate = new Date(dateString + 'T00:00:00'); // Ensure it's parsed as local time
                const currentDate = new Date('2025-10-29T00:00:00'); // Fixed current date for consistency
                const differenceInTime = currentDate.getTime() - referralDate.getTime();
                const differenceInDays = Math.max(0, Math.floor(differenceInTime / (1000 * 3600 * 24))); // Ensure non-negative
                return differenceInDays;
            }

            function formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }


            // --- DYNAMIC CONTENT RENDERING ---
            function displayReferralList() {
                referralsContainer.innerHTML = '';

                // Sort referrals by date, newest first
                const sortedReferrals = [...referralsData].sort((a, b) => new Date(b.referralSentDate) - new Date(a.referralSentDate));

                // Adjust grid columns based on number of referrals
                referralsContainer.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'lg:grid-cols-4'); 
                if (sortedReferrals.length <= 2) {
                    referralsContainer.classList.add('md:grid-cols-2');
                } else if (sortedReferrals.length === 3) {
                     referralsContainer.classList.add('lg:grid-cols-3');
                } else { // 4 or more
                     referralsContainer.classList.add('lg:grid-cols-4');
                }

                sortedReferrals.forEach((referral, index) => {
                    const daysElapsed = calculateDaysElapsed(referral.referralSentDate);
                    const formattedDate = formatDate(referral.referralSentDate);
                    const card = document.createElement('div');
                    // Added flex-col and justify-between for better layout with new info
                    card.className = 'glass-container card-hover-effect !bg-white/10 p-5 text-white text-center rounded-2xl cursor-pointer transition transform card-enter flex flex-col justify-between h-full'; 
                    card.style.animationDelay = `${index * 100}ms`;
                    
                    card.addEventListener('click', () => displayReferralDetails(referral.id));
                    card.innerHTML = `
                        <div> {/* Container for top content */}
                            <h3 class="text-lg md:text-xl font-bold mb-1">${referral.name}</h3> 
                            <p class="opacity-70 text-xs md:text-sm mb-2">ID: ${referral.id}</p> 
                        </div>
                        <div class="mt-auto border-t border-white/20 pt-2"> {/* Container for bottom date info */}
                             <p class="text-xs opacity-80">Sent: ${formattedDate}</p>
                             <p class="text-xs font-semibold ${daysElapsed > 7 ? 'text-red-300' : 'text-green-300'}">
                                ${daysElapsed} day${daysElapsed !== 1 ? 's' : ''} ago
                             </p>
                        </div>
                    `;
                    referralsContainer.appendChild(card);
                });
                showScreen(referralListSection);
            }

            function createIcon(path, classes = "w-6 h-6 mr-3 inline-block shrink-0") {
                return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${path}</svg>`;
            }

            function displayReferralDetails(id) {
                const referral = referralsData.find(r => r.id === id);
                if (!referral) return;

                // Use the full name (emailFullName) only for the email draft
                const emailBody = `Good afternoon ${referral.referralContactName},\n\nThank you for reaching out. T&T Serenity Care is interested in learning more about the referral for ${referral.emailFullName} (ID: ${referral.id}).\n\nWe have reviewed the initial documentation and believe we may be a good fit. Please let us know the next steps for a potential placement.\n\nBest regards,\n\nT&T Serenity Care`;

                // Generate QSI Report link HTML, handling missing QSI doc
                const qsiLinkHTML = referral.assets.qsi ? `
                    <a href="${referral.assets.qsi}" target="_blank" rel="noopener noreferrer" class="block bg-black/20 hover:bg-black/30 p-4 rounded-lg transition duration-300 card-hover-effect">
                         <p class="font-semibold text-lg">üìä</p><p class="font-semibold text-sm">QSI Report</p>
                    </a>` : `
                    <div class="block bg-gray-700/30 p-4 rounded-lg cursor-not-allowed">
                         <p class="font-semibold text-lg text-gray-500">üìä</p><p class="font-semibold text-sm text-gray-500">QSI Report</p><p class="text-xs text-gray-400">(N/A)</p>
                    </div>`;

                detailContent.innerHTML = `
                    <div class="space-y-8">
                         <!-- Hero Section -->
                        <div class="text-center p-4 rounded-2xl relative card-enter">
                            <div class="absolute inset-0 bg-black/20 rounded-2xl -z-10"></div>
                            <div class="flex flex-col items-center">
                                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-4xl font-bold text-white mb-4 shadow-lg">
                                    ${referral.fullName.charAt(0)}
                                </div>
                                <h1 class="text-4xl font-bold hero-name tracking-tight">${referral.fullName}</h1>
                                <p class="text-indigo-200">ID: ${referral.id}</p>
                            </div>
                        </div>

                        <!-- Main Grid Layout -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                            <!-- Left Column -->
                            <div class="lg:col-span-2 space-y-8">
                                <!-- Alerts -->
                                <div class="card-enter card-hover-effect glass-container !bg-red-900/30 border border-red-400/50 p-6 rounded-2xl" style="animation-delay: 100ms;">
                                     <h3 class="font-bold text-xl mb-3 flex items-center alert-heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>')} Key Alerts</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm body-text-color">
                                        <p class="flex items-start"><strong class="alert-label-color mr-2">Allergies:</strong><span>${referral.allergies}</span></p>
                                        <p class="flex items-start"><strong class="alert-label-color mr-2">Evacuation Risk:</strong><span>${referral.evacuationRisk}</span></p>
                                    </div>
                                </div>
                                <!-- Medical -->
                                <div class="card-enter card-hover-effect glass-container p-6 rounded-2xl" style="animation-delay: 200ms;">
                                    <h3 class="font-bold text-xl mb-4 flex items-center heading-color">${createIcon('<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>')} Medical & Health</h3>
                                    <div class="space-y-3 text-sm body-text-color">
                                        <p><strong class="label-color">Primary Diagnosis:</strong> ${referral.primaryDiagnosis}</p>
                                        <p><strong class="label-color">Other Diagnoses:</strong> ${referral.otherDiagnoses}</p>
                                        <p><strong class="label-color">Accommodations:</strong> ${referral.accommodations}</p>
                                        <p><strong class="label-color">Medications:</strong> ${referral.medications}</p>
                                    </div>
                                </div>
                                <!-- Behavioral -->
                                <div class="card-enter card-hover-effect glass-container p-6 rounded-2xl" style="animation-delay: 300ms;">
                                    <h3 class="font-bold text-xl mb-4 flex items-center heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>')} Behavioral Profile</h3>
                                    <div class="space-y-3 text-sm body-text-color">
                                        <p><strong class="label-color">Key Issues:</strong> ${referral.behavioralIssues}</p>
                                        <p><strong class="label-color">Social Context:</strong> ${referral.behavioralSocial}</p>
                                        <div class="!mt-4 p-4 rounded-lg bg-black/20 border border-purple-400/30">
                                            <p><strong class="label-color">History Note:</strong> ${referral.behavioralHistory}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Right Column -->
                            <div class="space-y-8">
                                 <!-- QSI Chart -->
                                <div class="card-enter card-hover-effect glass-container p-6 rounded-2xl" style="animation-delay: 150ms;">
                                    <h3 class="font-bold text-xl mb-3 flex items-center heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>')} QSI At-a-Glance</h3>
                                    <canvas id="qsiChart"></canvas>
                                </div>
                                <!-- Key Info -->
                                <div class="card-enter card-hover-effect glass-container p-6 rounded-2xl" style="animation-delay: 250ms;">
                                    <h3 class="font-bold text-xl mb-4 flex items-center heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>')} Key Information</h3>
                                    <div class="space-y-3 text-sm body-text-color">
                                        <p><strong class="label-color">DOB:</strong> ${referral.dob}</p>
                                        <p><strong class="label-color">Referral:</strong> ${referral.referralType} (${referral.dates})</p>
                                    </div>
                                </div>
                                <!-- Contacts -->
                                <div class="card-enter card-hover-effect glass-container p-6 rounded-2xl" style="animation-delay: 350ms;">
                                    <h3 class="font-bold text-xl mb-4 flex items-center heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>')} Key Contacts</h3>
                                    <div class="space-y-3 text-sm body-text-color">
                                        <div>
                                            <p class="font-bold label-color">Legal Representative:</p>
                                            <p>${referral.legalRep} | <a href="tel:${referral.legalRepPhone}" class="underline hover:text-white">${referral.legalRepPhone}</a></p>
                                            <p>${referral.legalRepEmail !== 'N/A' ? `<a href="mailto:${referral.legalRepEmail}" class="underline hover:text-white">${referral.legalRepEmail}</a>` : 'Email N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="font-bold label-color">Support Coordinator:</p>
                                            <p>${referral.wscName} | <a href="tel:${referral.wscPhone}" class="underline hover:text-white">${referral.wscPhone}</a></p>
                                            <p><a href="mailto:${referral.wscEmail}" class="underline hover:text-white">${referral.wscEmail}</a></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                         <!-- Documents -->
                        <div class="card-enter glass-container p-6 rounded-2xl mt-8" style="animation-delay: 400ms;">
                             <h3 class="font-bold text-xl mb-4 flex items-center heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>')} Attached Documents</h3>
                             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                                <a href="${referral.assets.email}" target="_blank" rel="noopener noreferrer" class="block bg-black/20 hover:bg-black/30 p-4 rounded-lg transition duration-300 card-hover-effect">
                                    <p class="font-semibold text-lg">üìß</p><p class="font-semibold text-sm">Referral Email</p>
                                </a>
                                <a href="${referral.assets.form}" target="_blank" rel="noopener noreferrer" class="block bg-black/20 hover:bg-black/30 p-4 rounded-lg transition duration-300 card-hover-effect">
                                     <p class="font-semibold text-lg">üìã</p><p class="font-semibold text-sm">Referral Form</p>
                                </a>
                                <a href="${referral.assets.pcsp}" target="_blank" rel="noopener noreferrer" class="block bg-black/20 hover:bg-black/30 p-4 rounded-lg transition duration-300 card-hover-effect">
                                     <p class="font-semibold text-lg">ü§ù</p><p class="font-semibold text-sm">Support Plan</p>
                                </a>
                                ${qsiLinkHTML} 
                            </div>
                        </div>

                        <!-- Email Draft -->
                        <div class="card-enter glass-container p-6 mt-8 rounded-2xl" style="animation-delay: 500ms;">
                             <h3 class="font-bold text-xl mb-4 flex items-center heading-color">${createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>')} Express Interest</h3>
                             <p class="text-sm opacity-80 mb-2">To: ${referral.referralContactEmail}</p>
                             <div class="relative">
                                <textarea id="email-draft-text" rows="6" class="w-full bg-black/20 p-3 rounded-lg body-text-color text-sm border border-white/20 custom-scrollbar" readonly>${emailBody}</textarea>
                                <button id="copy-email-button" class="absolute top-2 right-2 bg-white/30 hover:bg-white/50 text-white font-bold py-1 px-3 text-xs rounded-md transition duration-300">Copy</button>
                             </div>
                        </div>
                    </div>
                `;
                
                // Initialize QSI Chart
                const ctx = document.getElementById('qsiChart').getContext('2d');
                 if (qsiChart) {
                    qsiChart.destroy();
                }
                 // Check if QSI data exists before creating chart
                 if (referral.qsiPhysical !== undefined && referral.qsiFunctional !== undefined && referral.qsiBehavioral !== undefined) {
                    qsiChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['Physical', 'Functional', 'Behavioral'],
                            datasets: [{
                                label: 'QSI Scores',
                                data: [referral.qsiPhysical, referral.qsiFunctional, referral.qsiBehavioral],
                                backgroundColor: 'rgba(194, 178, 255, 0.3)',
                                borderColor: 'rgba(194, 178, 255, 0.9)',
                                pointBackgroundColor: 'rgba(255, 255, 255, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(194, 178, 255, 1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(255, 255, 255, 0.3)' },
                                    grid: { color: 'rgba(255, 255, 255, 0.3)' },
                                    pointLabels: { color: 'white', font: { size: 14 } },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        backdropColor: 'transparent',
                                        stepSize: 1
                                    },
                                suggestedMin: 0,
                                suggestedMax: 7 // Adjusted max based on QSI scores
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                 } else {
                     // Optionally display a message if QSI data is missing
                     ctx.font = "14px Inter";
                     ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                     ctx.textAlign = "center";
                     ctx.fillText("QSI Data Not Available", ctx.canvas.width / 2, ctx.canvas.height / 2);
                 }


                // Add event listener for the new copy button
                const copyButton = document.getElementById('copy-email-button');
                const emailText = document.getElementById('email-draft-text');
                copyButton.addEventListener('click', () => {
                    emailText.select();
                    document.execCommand('copy');
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = 'Copy';
                    }, 2000);
                });


                showScreen(referralDetailSection);
            }

            // --- EVENT LISTENERS ---
            submitButton.addEventListener('click', handleLogin);
            usernameInput.addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
            accessCodeInput.addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
            
            logoutButtons.forEach(btn => btn.addEventListener('click', logout));
            backToListButton.addEventListener('click', () => {
                 if (qsiChart) {
                    qsiChart.destroy();
                    qsiChart = null;
                }
                displayReferralList();
            });

            // --- INITIALIZATION ---
            if (sessionStorage.getItem('isAuthenticated') === 'true') {
                displayReferralList();
            } else {
                showScreen(loginSection);
            }
        });
    </script>
</body>
</html>

